<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
  <head> 
    {% include 'head.html' %}
    <script> window.beaconSdkDebugEnabled = true    </script>
    <script src="/static/walletbeacon.min.js"></script>

  </head>

  <body>
    {% include "dapp_nav_bar.html" %}

<div class="p-5"> 

    <span>
      Active account : <span id="activeAccount"></span><br>
      Network : <span id="activeAccountNetwork"></span><br>
      Transport : <span id="activeAccountTransport"></span>
    </span>
    <br /><br />
    
    
      <button  style="background-color: rgb(211, 148, 148)" id="requestPermission">Synchronize your wallet (Altme, Temple, KuKai, Naan.....)</button>
      <br /><br />
    
      <div id="altme">
      <form action="/sandbox/saas4ssi/dapp" method = "POST">
        <button id="synchroAltmeButton"  style="background-color: rgb(211, 148, 148)" type="submit" >Add your active account to Altme</button><br>
        <input id="synchroAltme" hidden name="address" value="">
        <input id="synchroAltmeWallet" hidden name="wallet" value="">
      </form>
    </div>

    <br /><br />
    <button id="sendToSelf">Send 1 mutez to myself</button>
    <br /><br />
    <button id="sendToSelfWithPrepare">Send 1 mutez to myself (with 1s prepare delay)</button>
    <br /><br />
    <button id="showPrepareAndHide">Show prepare and then hide</button>
    <br /><br />
    <button id="connect">Connect and Delegate</button>
    <br /><br />
    <button id="sendContractCall">Send Contract Call</button>
    <br /><br />

    <h3> Sign payloads </h3>
    Payload = <input id="PayloadValue"  size="100" type="text" value="Any string">
    <br /><br />
    <button id="signPayloadRaw">Sign Payload (Raw)</button>  
    <br /><br />
    <button id="signPayloadOperation">Sign Payload (Operation)</button>
    <br /><br />
    <button id="signPayloadMicheline">Sign Payload (Micheline)</button>
    <br /><br />

    <h3> Use cases with an Issuer</h3>
    <button id="signPayloadAltme" style="background-color: rgb(140, 219, 121)">Get your Welcome card</button>
    <br><br>  
    <button id="signPayloadBloometa" style="background-color: rgb(140, 219, 121) ">Get your Bloometa gaming card</button>
    <br><br>  
    <button id="signPayloadVoucher" style="background-color: rgb(140, 219, 121) ">Get your 15% Tezotopia voucher</button>
    <br><br> 

    <h3> Use cases with a Verifier</h3>
    <button id="signPayloadOver18" style="background-color: rgb(140, 219, 121) ">Prove that you are over 18 ? </button>
    <br><br> 
    <button id="signPayloadOver13" style="background-color: rgb(140, 219, 121) ">Prove that your are over 13 ? </button>
    <br><br> 
    <button id="signPayloadArago" style="background-color: rgb(140, 219, 121) ">Prove that you have an Arago Pass ? </button>

    <br /><br /><br /><br /><br /><br />
    <button id="sendNotification">Send notification</button>
    <br /><br />
    ---
    <br /><br />
    <button id="encryptPayload">Encrypt Payload</button>
    <br /><br />
    ---
    <br /><br />
    <button id="getExtensions">Get Extensions</button>
    <br /><br />
    ---
    <br /><br />
    <button id="clearActiveAccount">Clear ActiveAccount</button>
    <br /><br />
    <button id="getAccounts">Get Accounts</button>
    <br /><br />
    <button id="switchAccount">Switch Accounts</button>
    <br /><br />
    ---
    <br /><br />
    Reproducing bugs:
    <br /><br />
    <button id="externalInit">External Init</button>
    <br /><br />
    <button id="2requests">2 requests at once</button>
    <br /><br />
    ---
    <br /><br />
    <button id="removePeer">Remove Peer</button>
    <br /><br />
    ---
    <br /><br />
    <span>
      Color Mode:
      <span id="activeColorMode"></span>
    </span>
    <br /><br />
    <button id="color-mode-light">Set color mode "light"</button>
    <br /><br />
    <button id="color-mode-dark">Set color mode "dark"</button>
    <br /><br />
    ---
    <br /><br />
    <button id="contractCall">Contract Call</button>
    <br /><br />
    <textarea id="beacon-textbox"></textarea>
    <button id="deserializeData">Deserialize Data</button>
    <br /><br />
    ---
    <textarea id="beacon-textbox-serialize"></textarea>
    <button id="serializeData">Serialize Data</button>
    <br /><br />
    ---
    <br /><br />
    <button id="reset">Reset and Refresh</button>
    <br /><br />

    <div id="logger-output"></div>

    <br /><br />
    <p style="margin-top: 1000px">End of page</p> 

  </div>

    <script>
      class MyLogger {
        constructor() {}

        debug(name, method, ...args) {
          const el = document.createElement('div')
          el.innerText = `'debug' ${name} ${method} ${args.join(', ')}`
          el.setAttribute('style', 'background-color: blue')
          document.getElementById('logger-output').appendChild(el)
        }

        log(name, method, ...args) {
          const el = document.createElement('div')
          el.innerText = `'log' ${name} ${method} ${args.join(', ')}`
          el.setAttribute('style', 'background-color: green')
          document.getElementById('logger-output').appendChild(el)
        }

        warn(name, method, ...args) {
          const el = document.createElement('div')
          el.innerText = `'warn' ${name} ${method} ${args.join(', ')}`
          el.setAttribute('style', 'background-color: orange')
          document.getElementById('logger-output').appendChild(el)
        }

        error(name, method, ...args) {
          const el = document.createElement('div')
          el.innerText = `'error' ${name} ${method} ${args.join(', ')}`
          el.setAttribute('style', 'background-color: red')
          document.getElementById('logger-output').appendChild(el)
        }
      }

      const x = new MyLogger()

      beacon.setLogger(x);

      document.getElementById('altme').style.visibility = 'hidden';


      // Initiate DAppClient
      const client = beacon.getDAppClientInstance({
        name: 'Altme', // Name of the DApp,
        disclaimerText: '',
        errorMessages: {
          KT1RPW5kTX6WFxg8JK34rGEU24gqEEudyfvz: {
            NOT_OWNER: 'You are not the owner of this token.'
          }
        }
        // preferredNetwork: beacon.NetworkType.DELPHINET
        // matrixNodes: ['test.papers.tech', 'test2.papers.tech', 'matrix.papers.tech']
        // matrixNodes: ['beacon-node-0.papers.tech:8448']
        // matrixNodes: ['matrix.papers.tech']
        // matrixNodes: ['beacon.tztip.me']
      })

      // Display the active account in the UI
      const updateActiveAccount = () => {
        client.getActiveAccount().then((activeAccount) => {
          if (activeAccount) {
            console.log(activeAccount)
            document.getElementById('activeAccount').innerText = activeAccount.address
            document.getElementById('activeAccountNetwork').innerText = activeAccount.network.type
            document.getElementById('activeAccountTransport').innerText = activeAccount.origin.type
            document.getElementById("synchroAltme").value = activeAccount.address
            document.getElementById('altme').style.visibility = 'visible';

          } else {
            document.getElementById('activeAccount').innerText = ''
            document.getElementById('activeAccountNetwork').innerText = ''
            document.getElementById('activeAccountTransport').innerText = ''
          }
        })
      }
      updateActiveAccount()

      // Display the active account in the UI
      const updateColorMode = () => {
        client.getColorMode().then((colorMode) => {
          document.getElementById('activeColorMode').innerText = colorMode
        })
      }
      updateColorMode()

      // Initiate a delegate operation
      const delegate = () => {
        client.requestOperation({
          operationDetails: [
            {
              kind: beacon.TezosOperationType.DELEGATION,
              delegate: 'tz1MJx9vhaNRSimcuXPK2rW4fLccQnDAnVKJ'
            }
          ]
        })
      }

      // Initiate a delegate operation
      const sendToSelf = () => {
        return client.getActiveAccount().then((activeAccount) => {
          return client.requestOperation({
            operationDetails: [
              {
                kind: beacon.TezosOperationType.TRANSACTION,
                destination: activeAccount?.address ?? '',
                amount: '1'
              }
            ]
          })
        })
      }

      // send contract call
      const sendContractCall = () => {
        return client.getActiveAccount().then(async (activeAccount) => {
          const TZ_BUTTON_COLORS_CONTRACT = 'KT1RPW5kTX6WFxg8JK34rGEU24gqEEudyfvz'
          const tokenId = '925'

          // Setting the color of TzButton is only possible if you are currently the leader and own a color
          // So this call will likely fail
          try {
            const result = await client.requestOperation({
              operationDetails: [
                {
                  kind: beacon.TezosOperationType.TRANSACTION,
                  amount: '0',
                  destination: TZ_BUTTON_COLORS_CONTRACT,
                  parameters: {
                    entrypoint: 'set_color',
                    value: {
                      int: tokenId
                    }
                  }
                }
              ]
            })

            console.log(result)
          } catch (error) {
            console.log(`The contract call failed and the following error was returned:`, error)
          }
        })
      }

      // Initiate a permission request
      const requestPermission = (callback) => {
        client
          .requestPermissions(/*{ network: { type: beacon.NetworkType.DELPHINET } }*/)
          .then((permissions) => {
            console.log('permissions', permissions)
            if (callback) {
              callback(permissions)
            }
            updateActiveAccount()
          })
          .catch((error) => {
            console.log('error during permission request', error)
          })
      }

      document.getElementById('connect').addEventListener('click', () => {
        // Check if we have an active account
        client.getActiveAccount().then((activeAccount) => {
          if (activeAccount) {
            // If we have an active account, send the delegate operation directly
            delegate()
          } else {
            // If we don't have an active account, we need to request permissions first and then send the delegate operation
            requestPermission((permissions) => {
              delegate()
              updateActiveAccount()
            })
          }
        })
      })

      // Add event listener to the button
      document.getElementById('sendContractCall').addEventListener('click', () => {
        sendContractCall()
      })

      // Add event listener to the button
      document.getElementById('requestPermission').addEventListener('click', () => {
        requestPermission()
      })

      // Add event listener to the button
      document.getElementById('reset').addEventListener('click', () => {
        client.destroy().then(() => {
          window.location.reload()
        })
      })

// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

      // Add event listener to the button
      document.getElementById('signPayloadRaw').addEventListener('click', async () => {
        const inputPayload = document.getElementById('PayloadValue').value;
        const signature = await client.requestSignPayload({
          signingType: beacon.SigningType.RAW,
          payload: inputPayload
               })
        console.log('signature:', signature)
      })

       // Add event listener to the button
       document.getElementById('signPayloadOperation').addEventListener('click', async () => {
        const inputPayload = document.getElementById('PayloadValue').value;
        const payloadBytes = signPayload(inputPayload, 'OPERATION');
        console.log(payloadBytes);
        const signature = await client.requestSignPayload({
          signingType: beacon.SigningType.OPERATION,
          payload: payloadBytes
        })
        console.log('signature:', signature)
      })

      // Add event listener to the button
      document.getElementById('signPayloadMicheline').addEventListener('click', async () => {
        const inputPayload = document.getElementById('PayloadValue').value;
        const payloadBytes = signPayload(inputPayload, 'MICHELINE');
        console.log(payloadBytes);
        const signature = await client.requestSignPayload({
          signingType: beacon.SigningType.MICHELINE,
          payload: payloadBytes
        })
        console.log('signature:', signature)
      })


     //************************** Button green 
     
     
       // Add event listener to the button
       document.getElementById('signPayloadAltme').addEventListener('click', async () => {
        const signature = await client.requestSignPayload({
          signingType: beacon.SigningType.RAW,
          payload: 'Get your Welcome card ! #https://talao.co/sandbox/op/beacon/ormmcdomjv?issuer=did:ethr:0x64098e894fea5b83e7e4c52a30d70b98e25bd9d5'
               })
        console.log('signature:', signature)
      })

       // Add event listener to the button
       document.getElementById('signPayloadOver18').addEventListener('click', async () => {
        const signature = await client.requestSignPayload({
          signingType: beacon.SigningType.RAW,
          payload: 'I am over 18 years old#https://talao.co/sandbox/op/beacon/verifier/jvlfopeogt'
               })
        console.log('signature:', signature)
      })


        // Add event listener to the button
        document.getElementById('signPayloadArago').addEventListener('click', async () => {
        const signature = await client.requestSignPayload({
          signingType: beacon.SigningType.RAW,
          payload: 'I have an Arago Pass#https://talao.co/sandbox/op/beacon/verifier/iblrvxsevz'
               })
        console.log('signature:', signature)
      })

      // Add event listener to the button
      document.getElementById('signPayloadOver13').addEventListener('click', async () => {
        const signature = await client.requestSignPayload({
          signingType: beacon.SigningType.MICHELINE,
          payload: '05010033363054657a6f73205369676e6564204d6573736167653a20616c746d652e696f20323032322d31302d32365430393a32333a34365a204920616d206f766572203133207965617273206f6c642368747470733a2f2f74616c616f2e636f2f73616e64626f782f6f702f626561636f6e2f76657269666965722f74756169747663726b6c3f6973737565723d6469643a747a3a747a314e796a7254554e7844705061714e5a3834697047454c4163545759673673354475'
               })
        console.log('signature:', signature)
      })

      // Add event listener to the button
      document.getElementById('signPayloadBloometa').addEventListener('click', async () => {
        const signature = await client.requestSignPayload({
          signingType: beacon.SigningType.RAW,
          payload: 'Get your Bloometa card ! #https://talao.co/sandbox/op/beacon/saunmrbsxk?issuer=did:tz:tz1NyjrTUNxDpPaqNZ84ipGELAcTWYg6s5Du'
               })
        console.log('signature:', signature)
      })

    // Add event listener to the button
   document.getElementById('signPayloadVoucher').addEventListener('click', async () => {
        const signature = await client.requestSignPayload({
          signingType: beacon.SigningType.RAW,
          payload: 'Get your Tezotopia voucher ! #https://talao.co/sandbox/op/beacon/kmjdgmvtpu?issuer=did:tz:tz1NyjrTUNxDpPaqNZ84ipGELAcTWYg6s5Du'
               })
        console.log('signature:', signature)
      })

      // Add event listener to the button
      document.getElementById('encryptPayload').addEventListener('click', async () => {
        const encryptionResponse = await client.requestEncryptPayload({
          encryptionType: beacon.EncryptionType.ASYMMETRIC,
          encryptionCryptoOperation: beacon.EncryptionOperation.ENCRYPT,
          payload: 'my-secret-string'
        })

        console.log('encrypted payload', encryptionResponse.payload)

        await new Promise((resolve) => setTimeout(resolve, 2000))

        const decryptionResponse = await client.requestEncryptPayload({
          encryptionType: beacon.EncryptionType.ASYMMETRIC,
          encryptionCryptoOperation: beacon.EncryptionOperation.DECRYPT,
          payload: encryptionResponse.payload
        })

        console.log('decrypted payload', decryptionResponse.payload)
      })

     

      // Add event listener to the button
      document.getElementById('clearActiveAccount').addEventListener('click', () => {
        client.setActiveAccount().then(() => {
          updateActiveAccount()
        })
      })

      // Add event listener to the button
      document.getElementById('getExtensions').addEventListener('click', () => {
        beacon.availableTransports.availableExtensions.then((extensions) => {
          console.log(extensions)
          alert(
            `There are ${extensions.length} extensions installed. Check the console for more info.`
          )
        })
      })

      // Add event listener to the button
      document.getElementById('getAccounts').addEventListener('click', () => {
        client.getAccounts().then((accounts) => {
          console.log(accounts)
          alert(`There are ${accounts.length} accounts stored. Check the console for more info.`)
        })
      })

      // Add event listener to the button
      document.getElementById('switchAccount').addEventListener('click', () => {
        client.getAccounts().then((accounts) => {
          client.getActiveAccount().then((activeAccount) => {
            if (!activeAccount) {
              if (accounts.length === 0) {
                return alert('No account to switch to')
              }

              return client.setActiveAccount(accounts[0]).then(() => {
                updateActiveAccount()
              })
            }
            const filtered = accounts.filter(
              (acc) => acc.accountIdentifier !== activeAccount.accountIdentifier
            )
            if (filtered.length === 0) {
              return alert('No account to switch to')
            }

            client.setActiveAccount(filtered[0]).then(() => {
              updateActiveAccount()
            })
          })
        })
      })

      // Add event listener to the button
      document.getElementById('removePeer').addEventListener('click', () => {
        client.getPeers().then((peers) => {
          if (peers.length > 0) {
            client.removePeer(peers[0], true).then(() => {
              console.log('peer removed', peers[0])
              updateActiveAccount()
            })
          } else {
            console.log('no peers to be removed')
          }
        })
      })

      // Add event listener to the button
      document.getElementById('synchroAltmeButton').addEventListener('click', () => {

        client.getPeers()
        .then((peers) => {
          if (peers.length > 0) {
            document.getElementById('synchroAltmeWallet').value=peers[0].name;
            client.removePeer(peers[0], true).then(() => {
              updateActiveAccount()
            })
          } else {
            console.log('no peers to be removed');
          }
        })
    })

      document.getElementById('externalInit').addEventListener('click', () => {
        console.log('This method has to be called directly after page load to reproduce the error')
        client.init().then(() => {
          console.log('init done')
          client.requestPermissions().then((permissions) => {
            console.log('permissions', permissions)
            if (callback) {
              callback(permissions)
            }
            updateActiveAccount()
          })
        })
      })

      // Add event listener to the button
      document.getElementById('contractCall').addEventListener('click', () => {
        client
          .requestOperation({
            operationDetails: [
              {
                kind: beacon.TezosOperationType.TRANSACTION,
                amount: '0',
                destination: 'KT1RxKJyi48W3bZR8HErRiisXZQw19HwLGWj',
                parameters: {
                  entrypoint: 'toggleStatus',
                  value: {
                    prim: 'True'
                  }
                }
              }
            ]
          })
          .then((response) => console.log(response))
          .catch((error) => console.log(error))
      })

      // Add event listener to the button
      document.getElementById('2requests').addEventListener('click', () => {
        setTimeout(sendToSelf, 0)
        setTimeout(sendToSelf, 1000)
      })

      // Add event listener to the button
      document.getElementById('sendToSelf').addEventListener('click', () => {
        sendToSelf()
      })

      // Add event listener to the button
      document.getElementById('sendToSelfWithPrepare').addEventListener('click', () => {
        client.showPrepare()
        setTimeout(() => {
          sendToSelf().catch((e) => {
            client.hideUI()
          })
        }, 2000)
      })

      // Add event listener to the button
      document.getElementById('showPrepareAndHide').addEventListener('click', () => {
        client.showPrepare()
        setTimeout(() => {
          client.hideUI()
        }, 2000)
      })

      // Add event listener to the button
      document.getElementById('color-mode-light').addEventListener('click', () => {
        client.setColorMode('light')
        updateColorMode()
      })

      // Add event listener to the button
      document.getElementById('color-mode-dark').addEventListener('click', () => {
        client.setColorMode('dark')
        updateColorMode()
      })

      // Add event listener to the button
      document.getElementById('deserializeData').addEventListener('click', () => {
        const value = document.getElementById('beacon-textbox').value
        console.log('Deserializing:', value)

        new beacon.Serializer()
          .deserialize(value)
          .then((res) => {
            console.log(res), console.log(JSON.stringify(res))
          })
          .catch(console.error)
      })

      // Add event listener to the button
      document.getElementById('serializeData').addEventListener('click', () => {
        const value = document.getElementById('beacon-textbox-serialize').value
        console.log('Serializing:', value)
        const parsed = JSON.parse(value)
        console.log(parsed)
        new beacon.Serializer().serialize(parsed).then(console.log).catch(console.error)
      })

      // Add event listener to the button
      document.getElementById('sendNotification').addEventListener('click', () => {
        client
          .sendNotification('Beacon Test', 'Message', '', 'xtz')
          .then((res) => console.log('Notification Response', res))
      })
    </script>



<script>

function char2Bytes(text){
  return text.split("")
  .map(c => c.charCodeAt(0).toString(16).padStart(2, "0"))
  .join("");
}

function signPayload(input, messageType){
  var date = new Date();
  var sep = '03';
  const formattedInput = [
    'Tezos Signed Message:',
    'altme.io',
    date.toISOString(),
    input,
  ].join(' ');
  console.log(formattedInput);
  const bytes = char2Bytes(formattedInput);
  console.log(bytes.length)
  if ( messageType == 'MICHELINE'){
    sep = '05';
  }
  const payloadBytes = sep + '01' + '00' + char2Bytes(bytes.length.toString()) +  bytes;
  console.log(payloadBytes);
  return payloadBytes
}
</script>  

{% include 'user_footer.html' %}
<script src="{{ url_for('static', filename='jquery.min.js') }}"></script>
<script src="{{ url_for('static', filename='bs-init.js') }}"></script>
<script src="{{ url_for('static', filename='theme.js') }}"></script>
<script src="{{ url_for('static', filename='bootstrap.min.js') }}"></script>


  </body>
</html>